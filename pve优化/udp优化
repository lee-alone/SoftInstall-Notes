# Proxmox VE (PVE) 系统与网络性能优化教程

本教程总结了在 Proxmox VE (PVE) 环境下，针对网络吞吐量（特别是 DNS 服务、高并发 TCP 连接）和系统资源限制进行的深度优化操作手册。

---

## 1. 内核参数优化 (sysctl)

通过调整内核参数，可以显著减少高并发下的丢包现象，并提高网络协议栈的处理能力。

### 1.1 创建配置文件
执行以下命令创建或编辑 DNS/网络优化配置文件：
```bash
nano /etc/sysctl.d/99-dns.conf
```

### 1.2 添加配置内容
将以下参数复制并粘贴到文件中：

```ini
# UDP 缓冲区（减少丢包，适用于高负载 DNS）
net.core.rmem_max = 26214400
net.core.wmem_max = 26214400
net.core.rmem_default = 26214400
net.core.wmem_default = 26214400

# NIC 队列（避免网卡 backlog 溢出）
net.core.netdev_max_backlog = 4096

# Socket backlog（提高 TCP upstream 稳定性）
net.core.somaxconn = 4096
net.ipv4.tcp_max_syn_backlog = 4096

# IP 分片阈值（DNSSEC 大包时减少丢包）
net.ipv4.ipfrag_high_thresh = 2621440
net.ipv4.ipfrag_low_thresh = 1966080

# TIME_WAIT 优化（加速 TCP 连接回收）
net.ipv4.tcp_fin_timeout = 15
net.ipv4.tcp_tw_reuse = 1

# 端口范围（避免高并发下端口耗尽）
net.ipv4.ip_local_port_range = 1024 65000

# TCP BBR 拥塞控制（大幅提升高负载下的吞吐量）
net.core.default_qdisc = fq
net.ipv4.tcp_congestion_control = bbr

# 虚拟内存优化（减少 Swap 使用，优先利用物理内存）
vm.swappiness = 10
vm.vfs_cache_pressure = 50
```

### 1.3 应用配置
保存并退出后，执行以下命令使配置生效：
```bash
sysctl --system
```

---

## 2. 系统资源限制优化 (limits.conf)

为了支持大量文件句柄和并发连接，需要调高系统的文件描述符限制。

### 2.1 编辑限制文件
```bash
nano /etc/security/limits.conf
```

### 2.2 添加以下配置至文件末尾
```text
* soft nofile 200000
* hard nofile 200000
```
*注：`*` 代表对所有用户生效。*

---

## 3. Systemd 系统配置

确保 Systemd 服务在全局范围内拥有足够的资源分配。

### 3.1 编辑 system.conf
```bash
nano /etc/systemd/system.conf
```

### 3.2 修改或添加以下项
```ini
DefaultLimitNOFILE=200000
DefaultTasksMax=infinity
```

### 3.3 重载配置
```bash
systemctl daemon-reexec
```

---

## 4. LXC 容器特殊优化

如果你的服务运行在 LXC 容器（如 Docker、DNS 等）中，可能需要解除一些权限限制。

### 4.1 编辑容器配置文件
定位并编辑对应容器的配置文件（将 `<CTID>` 替换为你的容器 ID，例如 `101`）：
```bash
nano /etc/pve/lxc/101.conf
```

### 4.2 添加以下配置
在文件末尾添加以下行，以允许容器运行某些高性能或特权操作：
```ini
lxc.apparmor.profile: unconfined
lxc.cap.drop:
```

*注意：`unconfined` 会降低容器的隔离安全性，请仅在受信任的内部服务环境（如此处的 DNS 聚合、内网穿透逻辑）中使用。*

---

## 5. 硬件与底层进阶优化

### 5.1 CPU 性能模式 (SpeedStep 优化)
PVE 默认使用 `powersave` 模式。为了降低请求处理延迟，建议切换为 `performance` 模式。

```bash
# 安装工具
apt install cpufrequtils
# 设置所有核心为性能模式
for i in /sys/devices/system/cpu/cpu*/cpufreq/scaling_governor; do echo "performance" > $i; done
```

### 5.2 ZFS 内存限制 (若使用 ZFS 存储)
如果你的 PVE 使用了 ZFS 存储，ZFS 默认会占用 50% 的物理内存作为 ARC 缓存。这可能导致容器/虚拟机因内存不足而崩溃。

```bash
# 限制 ZFS ARC 缓存最大为 8GB (根据你的总内存调整)
echo "options zfs zfs_arc_max=8589934592" > /etc/modprobe.d/zfs.conf
update-initramfs -u
```

### 5.3 关闭 CPU 安全补丁 (慎用 - 性能飞跃)
如果你在纯内网环境运行且对性能有极致追求，可以关闭 Spectre/Meltdown 等安全补丁，CPU 性能可提升 5%~15%。

1. 编辑 Grub：`nano /etc/default/grub`
2. 在 `GRUB_CMDLINE_LINUX_DEFAULT` 中添加 `mitigations=off`
3. 更新 Grub：`update-grub` 后重启。

---

## 总结
完成上述优化后，您的 PVE 系统将具备更强的抗压能力和更低的网络延迟。建议在操作完成后重启受影响的服务或容器，以确保所有更改完全生效。
