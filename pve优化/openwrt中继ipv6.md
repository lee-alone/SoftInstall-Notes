# OpenWrt 二级路由 IPv6 中继配置

在 OpenWrt 二级路由上配置 IPv6 中继，将上级路由（一级路由/光猫）获得的 IPv6 地址分配能力传递给下级设备，同时保持 IPv4 的 NAT 路由功能不变。

## 目录

- [原理说明](#原理说明)
- [步骤 1：WAN6 接口配置](#步骤-1wran6-接口配置)
- [步骤 2：WAN 接口配置](#步骤-2wan-接口配置)
- [步骤 3：LAN 接口配置](#步骤-3lan-接口配置)
- [步骤 4：SSH 命令行配置](#步骤-4ssh-命令行配置关键)
- [步骤 5：验证和测试](#步骤-5应用配置并验证)
- [常见问题](#常见问题与排查)

## 原理说明

OpenWrt 二级路由通过以下方式实现 IPv6 中继：

```
一级路由 (获得 IPv6 前缀) 
    ↓
OpenWrt 二级路由 (DHCPv6 中继)
    ↓
下级设备 (获得 IPv6 前缀)
```

**关键概念**：
- **WAN6 接口**：获取上游的 IPv6 前缀
- **中继模式**：将 IPv6 分配能力转发给 LAN 下的设备
- **NDP 代理**：处理 IPv6 邻居发现协议

## 步骤 1：WAN6 接口配置

通过 OpenWrt 管理界面配置 WAN6 接口获取 IPv6：

### 操作步骤

1. 登录 OpenWrt 路由器管理界面
2. 进入 **网络 → 接口**
3. 找到 **WAN6 接口**，点击 **编辑**
4. 在 **基本设置** 中：
   - **协议**：选择 **DHCPv6 客户端**
5. 点击 **保存并应用**

**目的**：让二级路由的 WAN 口能从一级路由获取 IPv6 地址和前缀。

## 步骤 2：WAN 接口配置

配置 WAN 接口开启上游中继：

### 操作步骤

1. 进入 **网络 → 接口**
2. 编辑 **WAN 接口**
3. 在 **基本设置** 中：
   - **IPv4 协议**：保持你当前的设置不变（DHCP 客户端或静态地址都可以）
   
   > ⚠️ **注意**：某些固件版本下，要显示 **IPv6 设置** 选项，必须将 IPv4 协议设为 **静态地址**。如果改回 DHCP 后 IPv6 失效，则需要保持静态地址。

4. 找到 **IPv6 设置** 部分，配置以下项：
   - **路由通告服务**：**中继模式**
   - **DHCPv6 服务**：**中继模式**
   - **NDP 代理**：**中继模式**

5. 点击 **保存**

## 步骤 3：LAN 接口配置

配置 LAN 接口开启下游中继：

### 操作步骤

1. 进入 **网络 → 接口**
2. 编辑 **LAN 接口**
3. 在 **基本设置** 中：
   - **IPv4 协议**：通常为 **静态地址**（LAN 接口的常用设置）

4. 找到 **IPv6 设置** 部分，配置以下项：
   - **路由通告服务**：**中继模式**
   - **DHCPv6 服务**：**中继模式**
   - **NDP 代理**：**中继模式**

5. 点击 **保存**

## 步骤 4：SSH 命令行配置（关键）

这是最关键且在图形界面中缺失的一步，用于激活 WAN 口的 DHCPv6 中继功能。

### 连接 SSH

使用 SSH 工具（如 PuTTY、FinalShell 或 macOS/Linux 终端）连接到 OpenWrt 路由器。

### 编辑 DHCP 配置

```bash
vi /etc/config/dhcp
```

找到 `config dhcp 'wan'` 这一段配置，在其中添加一行：

```
option master '1'
```

**添加后的效果**：

```ini
config dhcp 'wan'
    option interface 'wan'
    option master '1'
    # ... 其他配置
```

### 保存配置

按 `ESC` 键，输入 `:wq` 并回车保存并退出。

## 步骤 5：应用配置并验证

### 应用配置

1. 回到 OpenWrt 管理界面
2. 点击任意界面的 **保存 & 应用** 按钮，使所有更改生效

### 验证 IPv6

检查二级路由下的设备是否已获取到以 `2xxx:` 或 `24xx:` 开头的 IPv6 公网地址。

**验证方法**：

1. 进入 **网络 → 接口**，查看 WAN6 接口的 **IPv6 地址**
2. 在客户端设备上执行：
   ```bash
   ip -6 addr
   ```
3. 访问 [http://www.test-ipv6.com/](http://www.test-ipv6.com/) 进行 IPv6 连通性测试

## 常见问题与排查

### 问题 1：设备获取不到 IPv6 地址

**解决步骤**：

1. 确认一级路由已经开启 IPv6
2. 检查 WAN6 接口是否已获取到 IPv6 前缀
3. 验证 SSH 配置是否正确添加了 `option master '1'`
4. 重启 dnsmasq：
   ```bash
   /etc/init.d/dnsmasq restart
   ```

### 问题 2：IPv6 能用但测试网站得分不高

**症状**：设备获取了 IPv6 地址，但 test-ipv6.com 得分低或无法解析 IPv6 DNS

**解决方案**：

1. 进入 **网络 → DHCP/DNS**
2. 切换到 **高级设置** 选项卡
3. 取消勾选以下选项（如果有）：
   - **过滤 IPv6 AAAA 记录**
   - **禁止解析 IPv6 DNS 记录**
4. 点击 **保存 & 应用**

### 问题 3：IPv6 间歇性断连

**可能原因**：
- NDP 代理未正确配置
- DHCPv6 服务器响应超时

**解决方案**：
1. 确保三个中继模式都设置为 **中继**
2. 查看 dnsmasq 日志：
   ```bash
   logread | grep -i ipv6
   ```
3. 重启路由器网络服务：
   ```bash
   /etc/init.d/network restart
   ```

## IPv6 配置检查清单

- [ ] WAN6 接口设置为 **DHCPv6 客户端**
- [ ] WAN 接口配置三个中继模式
- [ ] LAN 接口配置三个中继模式
- [ ] `/etc/config/dhcp` 中添加了 `option master '1'`
- [ ] 配置已保存并应用
- [ ] 下级设备已获取 IPv6 地址
- [ ] test-ipv6.com 测试通过

---

**最后更新**：2024-12-15