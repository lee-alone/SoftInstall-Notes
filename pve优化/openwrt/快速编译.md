# OpenWrt å¿«é€Ÿç¼–è¯‘æŒ‡å—

ä½¿ç”¨å›½å†…é•œåƒå’Œä¼˜åŒ–å‚æ•°å¿«é€Ÿç¼–è¯‘ OpenWrt å›ºä»¶ã€‚

## ç›®å½•

- [å‡†å¤‡](#å‡†å¤‡)
- [è·å–æºç ](#è·å–æºç )
- [é…ç½®ç¼–è¯‘](#é…ç½®ç¼–è¯‘)
- [ç¼–è¯‘æ‰§è¡Œ](#ç¼–è¯‘æ‰§è¡Œ)
- [æ•…éšœæ’æŸ¥](#æ•…éšœæ’æŸ¥)

## å‡†å¤‡

**ç³»ç»Ÿè¦æ±‚**ï¼šUbuntu 20.04+ / Debian 11+  
**æœ€ä½é…ç½®**ï¼š4 æ ¸ CPUï¼Œ8GB å†…å­˜ï¼Œ20GB ç£ç›˜ç©ºé—´  
**æ—¶é—´ä¼°è®¡**ï¼šé¦–æ¬¡ç¼–è¯‘ 30-60 åˆ†é’Ÿï¼Œå¢é‡ç¼–è¯‘ 5-10 åˆ†é’Ÿ

### å®‰è£…ä¾èµ–

```bash
# æ›´æ–°è½¯ä»¶åŒ…ç´¢å¼•
apt update
apt upgrade -y

# å®‰è£…å¿…éœ€å·¥å…·
apt install -y \
    build-essential \
    libncurses5-dev \
    libncursesw5-dev \
    zlib1g-dev \
    gawk \
    git \
    gettext \
    libssl-dev \
    xsltproc \
    rsync \
    wget \
    python3 \
    python3-distutils \
    python3-setuptools
```

## è·å–æºç 

### ä½¿ç”¨ Gitee é•œåƒï¼ˆæ¨èï¼Œå›½å†…åŠ é€Ÿï¼‰

```bash
# åˆ›å»ºå·¥ä½œç›®å½•
mkdir -p ~/openwrt
cd ~/openwrt

# æµ…å…‹éš†ä¸»åˆ†æ”¯ï¼ˆåªè·å–æœ€æ–°ç‰ˆæœ¬ï¼‰
git clone --depth=1 https://gitee.com/mirrors/openwrt.git
cd openwrt
```

> ğŸ’¡ **æç¤º**ï¼šæµ…å…‹éš†ï¼ˆ--depth=1ï¼‰å¯å°†ä¸‹è½½æ—¶é—´ä» 30 åˆ†é’Ÿé™è‡³ 3-5 åˆ†é’Ÿ

### å®˜æ–¹æºï¼ˆå¤‡é€‰ï¼Œå›½å¤–è¾ƒå¿«ï¼‰

```bash
git clone https://github.com/openwrt/openwrt.git --depth=1
cd openwrt
```

## é…ç½®ç¼–è¯‘

### æ­¥éª¤ 1ï¼šæ›´æ–° Feeds

```bash
# ç¼–è¾‘ feeds é…ç½®ä½¿ç”¨å›½å†…é•œåƒ
cat feeds.conf.default | sed 's|https://git.openwrt.org|https://gitee.com/mirrors|g' > feeds.conf

# æˆ–æ‰‹åŠ¨ç¼–è¾‘
nano feeds.conf
```

**feeds.conf æ¨èå†…å®¹**ï¼š

```conf
src-git base https://gitee.com/mirrors/openwrt/feeds/base.git^0e9856a
src-git packages https://gitee.com/mirrors/openwrt/feeds/packages.git^a7ebd00
src-git luci https://gitee.com/mirrors/openwrt/feeds/luci.git^2e29b1c
src-git routing https://gitee.com/mirrors/openwrt/feeds/routing.git^a3d7d8b
```

### æ­¥éª¤ 2ï¼šæ›´æ–°å¹¶å®‰è£… Feeds

```bash
# æ›´æ–°æ‰€æœ‰ feeds
./scripts/feeds update -a

# å®‰è£…æ‰€æœ‰ feeds
./scripts/feeds install -a
```

> ğŸ’¡ **åŠ é€ŸæŠ€å·§**ï¼šä½¿ç”¨ `-f` å‚æ•°å¼ºåˆ¶æ›´æ–°
> ```bash
> ./scripts/feeds update -a -f
> ```

### æ­¥éª¤ 3ï¼šæ³¨å…¥è‡ªå®šä¹‰åŒ…ï¼ˆå¯é€‰ï¼‰

è‹¥éœ€è¦é¢å¤–çš„åŒ…ï¼ˆå¦‚ Passwallã€OpenClashï¼‰ï¼Œåœ¨è¿è¡Œ `./scripts/feeds install` å‰æ‰§è¡Œï¼š

```bash
# Passwall æ’ä»¶
git clone https://github.com/Lienol/openwrt-package.git -b main \
    package/lienol
```

### æ­¥éª¤ 4ï¼šç”Ÿæˆé…ç½®æ–‡ä»¶

```bash
# æ‰“å¼€èœå•å¼é…ç½®
make menuconfig
```

**å…³é”®é…ç½®é¡¹**ï¼š

| é€‰é¡¹ | å»ºè®®å€¼ | è¯´æ˜ |
|------|--------|------|
| Target System | æ ¹æ®ç¡¬ä»¶é€‰æ‹© | å¦‚ x86_64ã€ARM ç­‰ |
| Subtarget | é€‰æ‹©å¯¹åº”èŠ¯ç‰‡ | å¦‚ 64ã€cortex-a53 |
| Target Image | squashfs | å‹ç¼©æ ¹æ–‡ä»¶ç³»ç»Ÿ |
| Network/Firewall | âœ… å‹¾é€‰ | é˜²ç«å¢™æ¨¡å— |

ä¿å­˜é…ç½®ï¼šæŒ‰ `<Save>`ï¼Œå†æŒ‰ `<Exit>` ä¸¤æ¬¡è¿”å›æ§åˆ¶å°ã€‚

## ç¼–è¯‘æ‰§è¡Œ

### ä¸‹è½½ä¾èµ–æºç 

å…ˆä¸‹è½½æ‰€æœ‰ä¾èµ–çš„æºä»£ç ï¼Œé¿å…ç¼–è¯‘æ—¶ç½‘ç»œä¸­æ–­ï¼š

```bash
make download -j4
```

### å¹¶è¡Œç¼–è¯‘

```bash
# ä½¿ç”¨ 4 æ ¸ç¼–è¯‘ï¼ˆæ ¹æ® CPU æ ¸å¿ƒæ•°è°ƒæ•´ï¼‰
make -j4 V=s
```

**ç¼–è¯‘å‚æ•°è¯´æ˜**ï¼š

| å‚æ•° | è¯´æ˜ |
|------|------|
| `-j4` | å¹¶è¡Œç¼–è¯‘ 4 ä¸ªä»»åŠ¡ï¼ˆæ¨è CPU æ ¸æ•°ï¼‰ |
| `V=s` | æ˜¾ç¤ºè¯¦ç»†ç¼–è¯‘æ—¥å¿—ï¼ˆä¾¿äºè°ƒè¯•ï¼‰ |
| `V=99` | è¶…çº§è¯¦ç»†æ—¥å¿— |

### å¢é‡ç¼–è¯‘

ä¿®æ”¹é…ç½®åï¼Œæ— éœ€é‡æ–°ç¼–è¯‘æ•´ä¸ªé¡¹ç›®ï¼š

```bash
# åªé‡æ–°ç¼–è¯‘å˜æ›´éƒ¨åˆ†
make -j4 V=s

# ä¿ç•™æ—§çš„ç›®æ ‡æ–‡ä»¶ï¼Œåªé‡æ–°é“¾æ¥
make -j4 V=s 2>&1 | tee build.log
```

## ç¼–è¯‘è¾“å‡º

ç¼–è¯‘å®Œæˆåï¼Œå›ºä»¶å­˜æ”¾ä½ç½®ï¼š

```bash
# æŸ¥çœ‹ç¼–è¯‘ç»“æœ
ls -lh bin/targets/*/generic/

# å…¸å‹è¾“å‡º
-rw-r--r-- 1 root root 256M Feb 14 10:45 openwrt-target-*.img.gz
-rw-r--r-- 1 root root 128M Feb 14 10:46 openwrt-target-*.tar.gz
```

> ğŸ’¡ **æ£€æŸ¥å›ºä»¶**ï¼š
> ```bash
> file bin/targets/*/generic/*
> ```

## æ•…éšœæ’æŸ¥

### é—®é¢˜ 1ï¼šç£ç›˜ç©ºé—´ä¸è¶³

```bash
# æ£€æŸ¥ç£ç›˜ä½¿ç”¨
df -h

# æ¸…ç†ç¼–è¯‘åƒåœ¾
make clean
make distclean

# ä»…ä¿ç•™é…ç½®ï¼Œæ¸…é™¤ç¼–è¯‘äº§ç‰©
rm -rf build_dir dl
```

### é—®é¢˜ 2ï¼šæ‰¾ä¸åˆ°ä¾èµ–åŒ…

```bash
# é‡æ–°æ›´æ–° feeds
./scripts/feeds update -a -f
./scripts/feeds install -a

# æ¸…é™¤æœ¬åœ°ç¼“å­˜
make target/clean
```

### é—®é¢˜ 3ï¼šç¼–è¯‘è¿‡ç¨‹ä¸­æ–­

```bash
# æŸ¥çœ‹ä¸Šæ¬¡ç¼–è¯‘æ—¥å¿—
tail -100 ~/.ccache/log

# æ¸…é™¤ ccache ç¼“å­˜
ccache -C

# ä»ä¸­æ–­å¤„ç»§ç»­ç¼–è¯‘
make -j4 V=s
```

### é—®é¢˜ 4ï¼šå†…å­˜æº¢å‡ºï¼ˆOut of Memoryï¼‰

```bash
# å‡å°‘å¹¶è¡Œç¼–è¯‘æ•°
make -j2 V=s

# å¯ç”¨ ccache åŠ é€Ÿ
./scripts/feeds install ccache
make -j4 defconfig
make -j4
```

## å¿«é€Ÿç¼–è¯‘æ£€æŸ¥æ¸…å•

- [ ] å·²å®‰è£…æ‰€æœ‰ä¾èµ–åŒ…
- [ ] å·²ä½¿ç”¨ Gitee é•œåƒåŠ é€Ÿï¼ˆæ¨èï¼‰
- [ ] å·²æ‰§è¡Œ `./scripts/feeds update -a` å’Œ `./scripts/feeds install -a`
- [ ] å·²é€šè¿‡ `make menuconfig` é…ç½®ç›®æ ‡å’Œé€‰é¡¹
- [ ] å·²æ‰§è¡Œ `make download -j4` é¢„ä¸‹è½½æºç 
- [ ] å·²å¯ç”¨ ccache åŠ é€Ÿç¼–è¯‘ï¼ˆå¯é€‰ï¼‰
- [ ] å·²è®¾ç½®åˆç†çš„å¹¶è¡Œç¼–è¯‘æ•° `-jN`ï¼ˆN = CPU æ ¸æ•°ï¼‰

## æ€§èƒ½ä¼˜åŒ–

### 1. å¯ç”¨ç¼–è¯‘ç¼“å­˜ï¼ˆccacheï¼‰

```bash
# å®‰è£… ccache
apt install ccache -y

# æŸ¥çœ‹ ccache å¤§å°
ccache -s

# å¢åŠ  ccache å¤§å°
ccache -M 10G
```

### 2. ä½¿ç”¨ RAM ç£ç›˜åŠ é€Ÿ

```bash
# åˆ›å»º 4GB RAM ç£ç›˜
mkdir -p /mnt/ramdisk
mount -t tmpfs -o size=4G tmpfs /mnt/ramdisk

# å°† dl å’Œ build_dir é“¾æ¥åˆ° RAM ç£ç›˜
ln -s /mnt/ramdisk/dl dl
ln -s /mnt/ramdisk/build_dir build_dir
```

### 3. å›½å†…é•œåƒæºæ±‡æ€»

| é•œåƒæº | åœ°å€ | é€Ÿåº¦ |
|--------|------|------|
| Gitee | https://gitee.com/mirrors/ | â­â­â­â­â­ |
| Aliyun | https://mirrors.aliyun.com/ | â­â­â­â­ |
| USTC | https://mirrors.ustc.edu.cn/ | â­â­â­â­ |
| æ¸…å | https://mirrors.tuna.tsinghua.edu.cn/ | â­â­â­â­ |

---

**æœ€åæ›´æ–°**ï¼š2024-12-15