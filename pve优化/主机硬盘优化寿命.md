# PVE 主机硬盘寿命优化

在 Proxmox VE 宿主机上减少 SSD/硬盘写入，延长存储设备寿命。

## 目录

- [准备](#准备)
- [fstab 优化](#修改-fstab将临时目录挂载到内存)
- [systemd 日志优化](#优化-systemd-日志journald)
- [apt 缓存优化](#优化-apt-缓存)
- [关闭 swap](#禁用传统-swap可选)
- [启用 zram swap](#启用-zram-swap压缩内存-swap)
- [进阶优化](#进阶优化)

## 准备

**适用系统**：Debian / Proxmox VE  
**内存要求**：16GB  
**目标**：减少 SSD/硬盘写入，延长设备寿命

## 修改 fstab，将临时目录挂载到内存

### 编辑 fstab

```bash
nano /etc/fstab
```

### 添加 tmpfs 挂载

在文件末尾添加以下行：

```fstab
tmpfs   /tmp            tmpfs   defaults,noatime,mode=1777,size=1G     0  0
tmpfs   /var/tmp        tmpfs   defaults,noatime,mode=1777,size=1G     0  0
tmpfs   /var/log        tmpfs   defaults,noatime,mode=0755,size=512M   0  0
tmpfs   /var/cache/apt  tmpfs   defaults,noatime,mode=0755,size=512M   0  0
```

### 参数说明

| 参数 | 说明 |
|------|------|
| `defaults` | 使用默认挂载选项 |
| `noatime` | 禁用访问时间记录，避免无意义写入 |
| `mode=1777` | 设置目录权限为 1777（所有用户可读写） |
| `size=1G` | 限制占用内存大小（根据可用内存调整） |

### 应用挂载

重新加载 systemd：

```bash
systemctl daemon-reexec
```

手动挂载新目录：

```bash
mount -a
```

验证挂载成功：

```bash
df -h | grep tmpfs
```

**预期输出**：显示新挂载的 tmpfs 目录

## 优化 systemd 日志（journald）

### 编辑 journald 配置

```bash
nano /etc/systemd/journald.conf
```

### 配置内容

找到或添加以下配置项：

```ini
[Journal]
Storage=volatile
RuntimeMaxUse=200M
SystemMaxUse=200M
```

### 参数说明

| 参数 | 值 | 说明 |
|------|-----|------|
| `Storage` | volatile | 日志只存在内存，不写入磁盘 |
| `RuntimeMaxUse` | 200M | 运行时日志占用内存上限 |
| `SystemMaxUse` | 200M | 系统日志占用内存上限 |

> 💡 **提示**：如果日志尺寸超过设定值，旧的日志会自动删除。

### 应用配置

```bash
systemctl restart systemd-journald
```

验证配置：

```bash
journalctl --vacuum-size=1M
```

## 优化 apt 缓存

### 已挂载到 tmpfs

由于已将 `/var/cache/apt` 挂载到 tmpfs，apt 缓存不会写入 SSD。

### 定期清理缓存

每次更新后执行清理：

```bash
apt-get clean
```

### 自动清理（可选）

创建 cron 任务定期清理：

```bash
# 编辑 crontab
crontab -e

# 添加以下行（每周执行一次）
0 2 * * 0 apt-get clean
```

## 禁用传统 swap（可选）

16GB 内存通常足够，可以关闭宿主机 swap：

### 关闭 swap

```bash
swapoff -a
```

### 编辑 fstab

```bash
nano /etc/fstab
```

找到包含 swap 的行（通常是 `/dev/pve/swap`），添加 `#` 注释：

```bash
#/dev/pve/swap
```

### 验证

```bash
free -h
```

Swap 应显示 0B。

## 启用 zram swap（压缩内存 swap）

如果确实需要 swap（作为内存不足时的应急措施），使用 zram 可以压缩数据，减少对 SSD 的压力。

### 步骤 1：安装 zram 工具

```bash
apt install zram-tools -y
```

### 步骤 2：配置 zram

```bash
nano /etc/default/zramswap
```

编辑以下参数（以 16GB 内存为例）：

```ini
# zRAM 大小为内存的 50%（8GB）
SIZE_PERCENT=50

# 压缩算法（lz4 最快，zstd 压缩率最高）
ALGO=lz4

# 优先级（较低数值会优先使用 zram）
PRIORITY=10
```

### 步骤 3：启用 zram

```bash
systemctl enable zramswap
systemctl start zramswap
```

### 验证配置

```bash
zramctl
free -h
```

**预期输出**：应显示 `/dev/zram0` 及其大小

## 进阶优化

### 1. 禁用日志文件同步

```bash
nano /etc/systemd/journald.conf
```

添加：

```ini
SyncIntervalSec=0
```

这样日志不会立即同步到磁盘（只存在内存中）。

> ⚠️ **风险**：系统宕机时可能丢失日志。

### 2. 优化文件系统参数

如果使用 ext4：

```bash
# 查看文件系统
df -T /

# 禁用日志（如果不关键）
tune2fs -o journal_data_writeback /dev/pve/data
```

### 3. 启用 TRIM 支持（SSD 必需）

```bash
# 检查 SSD 是否支持 TRIM
lsblk -D

# 启用定期 TRIM
systemctl enable fstrim.timer
systemctl start fstrim.timer
```

### 4. 监控磁盘写入

```bash
# 安装 iotop
apt install iotop -y

# 查看实时 I/O 情况
iotop
```

## 完整优化检查清单

- [ ] 已编辑 `/etc/fstab`，挂载 tmpfs
- [ ] 已应用 `mount -a` 和 `systemctl daemon-reexec`
- [ ] 已验证 `df -h | grep tmpfs`
- [ ] 已配置 systemd journald（Storage=volatile）
- [ ] 已重启 journald 服务
- [ ] 已关闭或禁用传统 swap
- [ ] （可选）已启用 zram swap
- [ ] （可选）已启用 TRIM 定时任务
- [ ] 已创建 cron 任务自动清理 apt 缓存

## 监控和维护

### 查看内存使用情况

```bash
# 详细内存统计
free -h

# 查看 tmpfs 使用
df -h /tmp /var/tmp /var/log /var/cache/apt

# 查看 zram 压缩率
zramctl -a
```

### 监控磁盘寿命

```bash
# 如果磁盘支持 S.M.A.R.T
apt install smartmontools -y
smartctl -A /dev/sda | grep Remaining
```

### 日志备份（重要）

虽然日志存在内存中，但重要的日志应该定期备份到外部存储：

```bash
# 导出日志
journalctl > /mnt/backup/pve-logs-$(date +%Y%m%d).txt

# 创建定期备份任务
crontab -e
# 添加：0 3 * * 0 journalctl > /mnt/backup/logs-$(date +\%Y\%m\%d).txt
```

## 预期效果

| 优化项 | 效果 |
|--------|------|
| tmpfs 挂载 | 减少 60-80% 的磁盘写入 |
| journald 优化 | 减少 40-50% 的日志写入 |
| 禁用 atime | 减少 10-20% 的读操作开销 |
| zram swap | 避免直接写入 SSD，压缩率 2-3:1 |
| **综合优化** | **减少 80-90% 的磁盘写入** |

---

**最后更新**：2024-12-15