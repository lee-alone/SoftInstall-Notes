好的，我帮你把之前讨论的 **PVE 主机 SSD 写入优化**整合成一份完整操作手册，包括 tmpfs、journald、swap/zram。操作手册按步骤写清楚，方便你直接执行。

---

# 📝 PVE 主机 SSD 写入优化操作手册（16GB 内存示例）

## 1. 准备

* 适用系统：Debian / Proxmox VE
* 内存：16GB
* 目标：减少 SSD 写入，延长寿命

---

## 2. 修改 fstab，将临时目录挂载到内存

编辑 `/etc/fstab`，添加如下内容：

```fstab
tmpfs   /tmp            tmpfs   defaults,noatime,mode=1777,size=1G     0  0
tmpfs   /var/tmp        tmpfs   defaults,noatime,mode=1777,size=1G     0  0
tmpfs   /var/log        tmpfs   defaults,noatime,mode=0755,size=512M   0  0
tmpfs   /var/cache/apt  tmpfs   defaults,noatime,mode=0755,size=512M   0  0
```

* `noatime` 避免无意义写入
* `size=` 根据内存调整，16GB 内存示例如上

挂载新目录：

```bash
systemctl daemon-reexec
mount -a
df -h | grep tmpfs
```

---

## 3. 优化 systemd 日志（journald）

编辑 `/etc/systemd/journald.conf`：

```ini
[Journal]
Storage=volatile
RuntimeMaxUse=200M
SystemMaxUse=200M
```

* `Storage=volatile` → 日志只存在内存
* `RuntimeMaxUse` / `SystemMaxUse` → 日志占用内存上限

应用配置：

```bash
systemctl restart systemd-journald
```

---

## 4. 优化 apt 缓存

* 已经挂载 `/var/cache/apt` 到 tmpfs
* 每次更新后执行：

```bash
apt-get clean
```

确保缓存不会写入 SSD

---

## 5. 禁用传统 swap（可选）

* 16GB 内存足够，一般可以关闭宿主机 swap：

```bash
swapoff -a
sed -i 's@^/dev/pve/swap@#&@' /etc/fstab
```

* 验证：

```bash
free -h
```

Swap 应显示 0B

---

## 6. 启用 zram swap（压缩内存 swap）

保存为 `enable-zram-swap.sh`：

```bash
#!/bin/bash
# 启用 zram swap (适合 Debian / PVE)

set -e

# 计算 zram 大小 = 内存的 50%
MEM_KB=$(grep MemTotal /proc/meminfo | awk '{print $2}')
MEM_MB=$((MEM_KB / 1024))
ZRAM_MB=$((MEM_MB / 2))

echo "[INFO] 检测到内存 ${MEM_MB} MB，设置 zram 大小为 ${ZRAM_MB} MB"

# 安装依赖
apt-get update
apt-get install -y zram-tools

# 配置 zram-tools
cat >/etc/default/zramswap <<EOF
# zram 配置文件
ALGO=lz4
PERCENT=50
PRIORITY=100
EOF

# 启用 zram swap
systemctl enable zramswap --now

echo "[INFO] zram swap 已启用"
swapon --show
free -h
```

执行脚本：

```bash
chmod +x enable-zram-swap.sh
./enable-zram-swap.sh
```

---

## 7. 验证效果

```bash
mount | grep tmpfs
df -h | grep tmpfs
swapon --show
free -h
```

* tmpfs 是否挂载正确
* zram swap 是否启用
* Swap 不再写 SSD

---

## 8. 后续建议

1. 定期备份虚拟机和容器
2. 监控 SSD 温度（保证 <60℃）
3. 避免在宿主机上做大规模快照或频繁写日志


