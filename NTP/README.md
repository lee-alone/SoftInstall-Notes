# NTP - ç½‘ç»œæ—¶é—´åŒæ­¥æœåŠ¡

NTP (Network Time Protocol) æ˜¯ç”¨äºåŒæ­¥è®¡ç®—æœºç³»ç»Ÿæ—¶é—´çš„æ ‡å‡†åè®®ï¼Œç²¾åº¦å¯è¾¾æ¯«ç§’çº§ã€‚

## ğŸ“‹ å†…å®¹å¯¼èˆª

- [NTP å®Œæ•´é…ç½®æŒ‡å—](ntp.md) - å®‰è£…ã€é…ç½®ã€åŒæ­¥ã€æ•…éšœæ’æŸ¥

## ğŸ¯ å¿«é€Ÿå¼€å§‹

### æœ€å°åŒ–é…ç½®ï¼ˆ3 æ­¥ï¼‰

```bash
# 1. å®‰è£… NTP
apt install ntp -y

# 2. ç¼–è¾‘é…ç½®ï¼Œæ·»åŠ å›½å†…æ—¶é—´æœåŠ¡å™¨
nano /etc/ntpsec/ntp.conf

# 3. å¯åŠ¨æœåŠ¡
systemctl enable ntpsec
systemctl start ntpsec
```

### æ¨èçš„ NTP æœåŠ¡å™¨åˆ—è¡¨

```conf
# å›½å®¶æ—¶é—´æœåŠ¡ä¸­å¿ƒï¼ˆæ¨èé¦–é€‰ï¼‰
server ntp.ntsc.ac.cn prefer

# é˜¿é‡Œäº‘
server ntp1.aliyun.com
server ntp2.aliyun.com

# æ¸…åå¤§å­¦ TUNA
server ntp.tuna.tsinghua.edu.cn

# ä¸­ç§‘å¤§
server ntp.ustc.edu.cn
```

## ğŸ“– è¯¦ç»†è¯´æ˜

è¯¦è§ [NTP å®Œæ•´é…ç½®æŒ‡å—](ntp.md)

## ğŸ” æ ¸å¿ƒæ¦‚å¿µ

### NTP çš„ä½œç”¨

NTP é€šè¿‡ä»å¯ä¿¡çš„æ—¶é—´æºåŒæ­¥ç³»ç»Ÿæ—¶é—´ï¼Œè§£å†³ä»¥ä¸‹é—®é¢˜ï¼š

- âœ… åˆ†å¸ƒå¼ç³»ç»Ÿçš„æ—¶é—´ä¸€è‡´æ€§
- âœ… æ—¥å¿—è®°å½•çš„å‡†ç¡®æ—¶é—´æˆ³
- âœ… å¯†ç å­¦è®¡ç®—çš„æ—¶é—´ä¾èµ–
- âœ… æ•°æ®åº“äº‹åŠ¡çš„æ—¶é—´é¡ºåº
- âœ… é›†ç¾¤èŠ‚ç‚¹çš„æ—¶é—´åŒæ­¥

### å·¥ä½œåŸç†

```
NTP å®¢æˆ·ç«¯ â†’ æŸ¥è¯¢æ—¶é—´æœåŠ¡å™¨ â†’ è·å–ç²¾ç¡®æ—¶é—´ â†’ è°ƒæ•´ç³»ç»Ÿæ—¶é’Ÿ â†’ å®šæœŸæ›´æ–°
```

### Stratum åˆ†å±‚

| Stratum | è¯´æ˜ | ç¤ºä¾‹ |
|---------|------|------|
| 0 | åŸå­é’Ÿæˆ–å…¶ä»–æ—¶é—´æº | GPSã€æ— çº¿ç”µæ—¶é’Ÿ |
| 1 | ç›´æ¥è¿æ¥åˆ° Stratum 0 | å›½å®¶æ—¶é—´ä¸­å¿ƒ |
| 2 | è¿æ¥åˆ° Stratum 1 æœåŠ¡å™¨ | å¤§å¤šæ•°å…¬ç½‘ NTP |
| 3+ | è¿›ä¸€æ­¥çº§è” | å…¬å¸å†…éƒ¨ NTP |

**é‡ç‚¹**ï¼šä¼˜å…ˆé€‰æ‹© Stratum å€¼è¾ƒå°ï¼ˆ1-2ï¼‰çš„æœåŠ¡å™¨ã€‚

## ğŸŒ æ¨èæœåŠ¡å™¨é€‰æ‹©

### å›½å†…å¯é çš„ NTP æœåŠ¡å™¨

| æœåŠ¡å™¨ | Stratum | åœ°åŒº | è¯´æ˜ |
|--------|---------|------|------|
| ntp.ntsc.ac.cn | 1 | å…¨å›½ | å›½å®¶æ—¶é—´æœåŠ¡ä¸­å¿ƒï¼Œæœ€æƒå¨ |
| ntp1.aliyun.com | 2 | å…¨å›½ | é˜¿é‡Œäº‘ï¼Œç¨³å®šå¯é  |
| ntp.tuna.tsinghua.edu.cn | 2 | ååŒ— | æ¸…åå¤§å­¦ï¼Œå­¦æœ¯èµ„æº |
| ntp.ustc.edu.cn | 2 | åä¸œ | ä¸­ç§‘å¤§ï¼Œå­¦æœ¯èµ„æº |
| cn.ntp.org.cn | 2 | å…¨å›½ | NTP è”ç›Ÿï¼Œå›½å†…èŠ‚ç‚¹ |

### é€‰æ‹©å»ºè®®

- **æœåŠ¡å™¨è¾ƒå°‘çš„ç½‘ç»œ**ï¼šä½¿ç”¨ 1 ä¸ªä¸»æœåŠ¡å™¨ï¼ˆpreferï¼‰
- **ä¸­ç­‰è§„æ¨¡ç½‘ç»œ**ï¼šä½¿ç”¨ 3-4 ä¸ªæœåŠ¡å™¨
- **å¤§å‹ç½‘ç»œ**ï¼šéƒ¨ç½²æœ¬åœ° NTP æœåŠ¡å™¨ï¼ˆStratum 2ï¼‰ï¼Œå®¢æˆ·ç«¯åŒæ­¥åˆ°æœ¬åœ°æœåŠ¡å™¨

## ğŸ’» ä½¿ç”¨åœºæ™¯

### åœºæ™¯ 1ï¼šå•å° Linux æœåŠ¡å™¨

```bash
# å®‰è£…ã€é…ç½®ã€å¯åŠ¨
apt install ntp -y
# åœ¨ /etc/ntpsec/ntp.conf ä¸­æ·»åŠ æ—¶é—´æœåŠ¡å™¨
systemctl start ntpsec

# æ£€æŸ¥åŒæ­¥çŠ¶æ€
ntpq -p
```

### åœºæ™¯ 2ï¼šè™šæ‹ŸåŒ–ç¯å¢ƒ

**å®¿ä¸»æœº**ï¼š
```bash
# åŒæ­¥åˆ°å¤–éƒ¨ NTP æœåŠ¡å™¨
server ntp.ntsc.ac.cn prefer
```

**è™šæ‹Ÿæœº**ï¼š
```bash
# åŒæ­¥åˆ°å®¿ä¸»æœº
server å®¿ä¸»æœºIP prefer
```

### åœºæ™¯ 3ï¼šKubernetes é›†ç¾¤

æ‰€æœ‰èŠ‚ç‚¹åº”åŒæ­¥åˆ°åŒä¸€ä¸ª NTP æœåŠ¡å™¨ï¼ˆæˆ–æœåŠ¡å™¨ç»„ï¼‰ï¼š

```yaml
# åœ¨æ‰€æœ‰èŠ‚ç‚¹çš„ ntp.conf ä¸­
server ntp.ntsc.ac.cn prefer
server ntp1.aliyun.com
server ntp.tuna.tsinghua.edu.cn
```

### åœºæ™¯ 4ï¼šWindows + Linux æ··åˆç¯å¢ƒ

**Linux æœåŠ¡å™¨**ï¼š
```bash
server ntp.ntsc.ac.cn prefer
systemctl start ntpsec
```

**Windows å®¢æˆ·ç«¯**ï¼š
```powershell
# è®¾ç½® NTP æœåŠ¡å™¨ä¸º Linux æœåŠ¡å™¨ IP
w32tm /config /manualpeerlist:"LinuxæœåŠ¡å™¨IP" /syncfromflags:manual /update
w32tm /resync
```

## ğŸš€ å¸¸ç”¨æ“ä½œ

### æ£€æŸ¥åŒæ­¥çŠ¶æ€

```bash
# æŸ¥çœ‹å½“å‰åŒæ­¥çš„æœåŠ¡å™¨ï¼ˆå¸¦ * æ ‡è®°ï¼‰
ntpq -p

# ç®€æ´æ ¼å¼
ntpstat

# è¯¦ç»†ä¿¡æ¯
timedatectl
```

### ç«‹å³åŒæ­¥æ—¶é—´

```bash
# å¼ºåˆ¶åŒæ­¥ï¼ˆåœæ­¢ NTP æœåŠ¡åè¿è¡Œï¼‰
systemctl stop ntpsec
ntpd -q
systemctl start ntpsec
```

### è°ƒæ•´æ—¶åŒº

```bash
# åˆ—å‡ºæ‰€æœ‰æ—¶åŒº
timedatectl list-timezones | grep Shanghai

# è®¾ç½®ä¸ºä¸­å›½æ—¶åŒº
timedatectl set-timezone Asia/Shanghai

# éªŒè¯
timedatectl
```

### ç¡¬ä»¶æ—¶é’ŸåŒæ­¥

```bash
# å°†ç³»ç»Ÿæ—¶é—´å†™å›ç¡¬ä»¶æ—¶é’Ÿ
hwclock --systohc

# ä»ç¡¬ä»¶æ—¶é’Ÿè¯»å–
hwclock --hctosys
```

## ğŸ“Š æ€§èƒ½æŒ‡æ ‡

### ntpq -p è¾“å‡ºè§£é‡Š

```
     remote           refid      st t when poll reach   delay   offset  jitter
==============================================================================
+ntp.ntsc.ac.cn  .CDMA.          1 u   64   64  377   32.123   -1.234   2.345
*ntp1.aliyun.com .GPS.           1 u    8   64  377   15.234   -0.456   1.234
```

| åˆ—å | å«ä¹‰ | å€¼èŒƒå›´ |
|------|------|--------|
| st (Stratum) | æ—¶é—´æºç­‰çº§ | 1-15 |
| when | æœ€ååŒæ­¥ç»è¿‡æ—¶é—´(s) | ç§’æ•° |
| poll | è½®è¯¢é—´éš”(s) | ç§’æ•° |
| reach | å¯è¾¾æ€§ | å…«è¿›åˆ¶ï¼Œ377=100% |
| delay | ç½‘ç»œå»¶è¿Ÿ(ms) | æ¯«ç§’ |
| offset | æ—¶é—´åç§»(ms) | æ¯«ç§’ |
| jitter | æ—¶é—´æŠ–åŠ¨(ms) | æ¯«ç§’ |

### ç†æƒ³çŠ¶æ€

- reach = 377ï¼ˆåè¿›åˆ¶ 255ï¼Œè¡¨ç¤ºå…¨éƒ¨ 8 æ¬¡æŸ¥è¯¢æˆåŠŸï¼‰
- offset < 100msï¼ˆé€šå¸¸ < 10msï¼‰
- jitter < 50ms
- delay ä½äº 100ms

## ğŸ› å¸¸è§é—®é¢˜

### Q: ntpq -p è¾“å‡ºä¸ºç©º
**A:** NTP æœåŠ¡æœªè¿è¡Œï¼Œæ£€æŸ¥çŠ¶æ€ï¼š
```bash
systemctl status ntpsec
systemctl restart ntpsec
sleep 10
ntpq -p
```

### Q: æ‰€æœ‰æœåŠ¡å™¨éƒ½æ˜¾ç¤º "x"ï¼ˆä¸å¯è¾¾ï¼‰
**A:** 
1. æ£€æŸ¥ç½‘ç»œè¿æ¥ï¼š`ping ntp.ntsc.ac.cn`
2. æ£€æŸ¥é˜²ç«å¢™ï¼šUDP 123 ç«¯å£åº”å¼€æ”¾
3. æ£€æŸ¥é…ç½®æ–‡ä»¶ï¼š`nano /etc/ntpsec/ntp.conf`

### Q: æ—¶é—´åç¦»è¿‡å¤§æ— æ³•åŒæ­¥
**A:** 
1. æ£€æŸ¥ç³»ç»Ÿæ—¶é’Ÿå·®ï¼š`date`
2. å¦‚æœå·®å¼‚ > 1 å°æ—¶ï¼Œæ‰‹åŠ¨è°ƒæ•´ï¼š`date -s "2024-12-15 14:30:00"`
3. ç„¶åå¯åŠ¨ NTP é‡æ–°åŒæ­¥

### Q: NTP åŒæ­¥å¾ˆæ…¢
**A:** é¦–æ¬¡åŒæ­¥å¯èƒ½éœ€è¦ 15-30 åˆ†é’Ÿï¼Œè¿™æ˜¯æ­£å¸¸çš„ã€‚å¯ä»¥ï¼š
1. ç­‰å¾…è‡ªåŠ¨åŒæ­¥
2. æˆ–å¼ºåˆ¶å¿«é€ŸåŒæ­¥ï¼ˆè§ [è¯¦ç»†æŒ‡å—](ntp.md)ï¼‰

## ğŸ“ˆ ç›‘æ§å’Œæ—¥å¿—

### å®æ—¶ç›‘æ§

```bash
# æ¯ 10 ç§’åˆ·æ–°ä¸€æ¬¡
watch -n 10 'ntpq -p'

# ç›‘æ§æ—¶é—´åç§»å˜åŒ–
watch -n 1 'ntpq -p | grep "^\*"'
```

### æŸ¥çœ‹æ—¥å¿—

```bash
# systemd æ—¥å¿—
journalctl -u ntpsec -f

# syslogï¼ˆå¦‚æœå¯ç”¨ï¼‰
tail -f /var/log/syslog | grep ntpd
```

## ğŸ“ æœ€ä½³å®è·µ

1. **å¤šä¸ªæ—¶é—´æº**
   - è‡³å°‘ä½¿ç”¨ 3-4 ä¸ª NTP æœåŠ¡å™¨
   - é¿å…éƒ½é€‰æ‹©ç›¸åŒæœºæˆ¿çš„æœåŠ¡å™¨

2. **å®šæœŸéªŒè¯**
   ```bash
   # æ¯å°æ—¶æ£€æŸ¥ä¸€æ¬¡
   0 * * * * /usr/bin/ntpq -p >> /var/log/ntp-check.log
   ```

3. **è™šæ‹ŸåŒ–ç¯å¢ƒç‰¹æ®Šé…ç½®**
   - å®¿ä¸»æœºï¼šåŒæ­¥åˆ°å¤–éƒ¨ NTP
   - è™šæ‹Ÿæœºï¼šåŒæ­¥åˆ°å®¿ä¸»æœº
   - é¿å…å¤šå±‚ NTP åŒæ­¥é“¾

4. **å®¹å™¨åŒ–éƒ¨ç½²**
   ```bash
   # å®¹å™¨å†…å¯å…±äº«å®¿ä¸»æœºæ—¶é—´
   docker run -v /etc/timezone:/etc/timezone:ro -v /etc/localtime:/etc/localtime:ro ...
   ```

## ğŸ”— ç›¸å…³èµ„æº

- [NTP å®˜æ–¹ç½‘ç«™](https://www.ntp.org/)
- [ntpsec é¡¹ç›®](https://www.ntpsec.org/)
- [Microsoft Windows æ—¶é—´åŒæ­¥](https://docs.microsoft.com/zh-cn/windows-server/networking/windows-time-service/windows-time-service-top)

---

**æœ€åæ›´æ–°**ï¼š2024-12-15
