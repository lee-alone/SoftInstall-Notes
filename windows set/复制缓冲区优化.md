# Windows 系统 - 复制缓冲区优化

调整 Windows 系统复制缓冲区大小，提升大文件拷贝性能。

## 概述

Windows 系统默认的文件复制缓冲区较小，大文件传输时可能导致性能下降。通过调整注册表参数可以优化缓冲区大小。

## 原理说明

| 参数 | 说明 | 默认值 |
|------|------|--------|
| `LargeSystemCache` | 启用大型系统缓存 | 0（禁用） |
| `Size` | 缓冲区大小（字节） | 依赖系统配置 |

**优化效果**：
- 🟢 提升 30-50% 的文件拷贝速度
- 🟢 减少 CPU 和磁盘 I/O 争用
- 🔴 增加内存占用

## 快速优化

### 方法 1：运行优化脚本（推荐）

创建批处理文件 `optimize-copy.bat`：

```bat
@echo off
REM 复制缓冲区优化脚本
REM 需要管理员权限运行

echo 检查 LargeSystemCache 是否存在...
reg query "HKEY_LOCAL_MACHINE\SYSTEM\CurrentControlSet\Control\Session Manager\Memory Management" /v LargeSystemCache

if %errorlevel%==0 (
    echo LargeSystemCache 存在，设置值为 1...
    reg add "HKEY_LOCAL_MACHINE\SYSTEM\CurrentControlSet\Control\Session Manager\Memory Management" /v LargeSystemCache /t REG_DWORD /d 1 /f
) else (
    echo LargeSystemCache 不存在，创建并设置值为 1...
    reg add "HKEY_LOCAL_MACHINE\SYSTEM\CurrentControlSet\Control\Session Manager\Memory Management" /v LargeSystemCache /t REG_DWORD /d 1 /f
)

echo 将读取缓冲区大小更改为 512MB...
reg add "HKEY_LOCAL_MACHINE\SYSTEM\CurrentControlSet\Services\LanmanServer\Parameters" /v Size /t REG_DWORD /d 524288 /f

echo 完成。请重新启动计算机以使更改生效。
pause
```

**使用步骤**：

1. 将脚本保存为 `.bat` 文件
2. **右键 → 以管理员身份运行**
3. 按任意键关闭窗口
4. **重启计算机** 使设置生效

### 方法 2：手动修改注册表

#### 步骤 1：打开注册表编辑器

按 `Win + R`，输入：

```cmd
regedit
```

#### 步骤 2：修改 LargeSystemCache

导航到：

```
HKEY_LOCAL_MACHINE\SYSTEM\CurrentControlSet\Control\Session Manager\Memory Management
```

**操作**：
1. 右键新建 → DWORD（32 位值）
2. 命名为 `LargeSystemCache`
3. 数值数据设为 `1`
4. 点击 OK

#### 步骤 3：修改缓冲区大小

导航到：

```
HKEY_LOCAL_MACHINE\SYSTEM\CurrentControlSet\Services\LanmanServer\Parameters
```

**操作**：
1. 如果不存在 `Size` 参数，右键新建 → DWORD（32 位值）
2. 命名为 `Size`
3. 数值数据设为 `524288`（512 MB）或其他值，单位为 KB：
   - `262144` = 256 MB
   - `524288` = 512 MB
   - `1048576` = 1024 MB
4. 点击 OK

#### 步骤 4：应用设置

```
右键计算机 → 重启计算机
```

## 缓冲区大小参考

根据系统内存调整缓冲区大小：

| 系统内存 | 推荐大小 | 十进制值 |
|---------|---------|---------|
| 4GB | 256 MB | 262144 |
| 8GB | 512 MB | 524288 |
| 16GB | 1 GB | 1048576 |
| 32GB+ | 2 GB | 2097152 |

> ⚠️ **注意**：缓冲区大小不宜过大，建议不超过物理内存的 1/8

## 验证设置

### 使用注册表编辑器验证

1. 打开 `regedit`
2. 导航至上述两个位置
3. 确认 `LargeSystemCache = 1` 和 `Size = 524288`

### 使用 PowerShell 验证

```powershell
# 查询 LargeSystemCache
reg query "HKEY_LOCAL_MACHINE\SYSTEM\CurrentControlSet\Control\Session Manager\Memory Management" /v LargeSystemCache

# 查询 缓冲区大小
reg query "HKEY_LOCAL_MACHINE\SYSTEM\CurrentControlSet\Services\LanmanServer\Parameters" /v Size
```

## 常见问题

### Q：修改后没有效果

A：
1. 确保以管理员权限运行脚本或修改注册表
2. 修改后必须重启计算机才能生效
3. 检查修改的值是否正确（十进制）

### Q：缓冲区太大会怎样

A：
- 占用大量内存，影响其他程序
- 可能导致系统卡顿
- 建议设置为物理内存的 1/16 到 1/8

### Q：如何恢复默认设置

A：删除注册表中的这两个参数：
1. 打开 `regedit`
2. 删除 `LargeSystemCache` 键值
3. 删除 `Size` 键值
4. 重启计算机

## 性能测试

### 测试大文件拷贝速度

```cmd
REM 创建 1GB 测试文件
fsutil file createnew testfile.dat 1000000000

REM 复制文件（注意写入时间）
copy testfile.dat testfile_copy.dat

REM 删除测试文件
del testfile.dat testfile_copy.dat
```

预期改进：
- 小文件（< 100 MB）：提升 10-20%
- 中等文件（100 MB - 1 GB）：提升 30-50%
- 大文件（> 1 GB）：提升 50-80%

---

**最后更新**：2024-12-15